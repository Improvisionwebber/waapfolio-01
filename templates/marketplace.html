{% extends "base.html" %}
{% load static %}

{% block body %}
<style>
/* üåø WAAPFOLIO MARKETPLACE APPLE-LIKE STYLING üåø */
body {
  background: #f8fafc;
}

h4 {
  font-weight: 700;
  color: #0fa80f;
}

/* === Card Styling === */
.card {
  border: none;
  border-radius: 1.2rem;
  background: #ffffff;
  transition: all 0.3s ease;
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
}

.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.card-img-top {
  height: 180px;
  object-fit: cover;
  border-radius: 1.2rem 1.2rem 0 0;
  background-color: #f2f2f2;
}

.card-body {
  padding: 1rem 1.2rem;
}

.card-title {
  font-size: 1rem;
  font-weight: 600;
  color: #111;
  margin-bottom: 0.4rem;
}

.card-text {
  font-size: 0.88rem;
  color: #555;
  margin-bottom: 0.7rem;
}

.fw-bold {
  color: #0b840b;
  font-size: 0.95rem;
}

/* === Buttons === */
.btn-success {
  background-color: #0fa80f;
  border: none;
  border-radius: 1.2rem;
  padding: 0.35rem 0.9rem;
  font-size: 0.82rem;
}

.btn-success:hover {
  background-color: #0c860c;
}

.btn-outline-success {
  border-color: #0fa80f;
  color: #0fa80f;
  border-radius: 1.2rem;
  font-size: 0.82rem;
}

.btn-outline-success:hover {
  background-color: #0fa80f;
  color: white;
}

/* === Mixed Store Tag === */
.store-badge {
  background: #e8f5e9;
  color: #0b840b;
  font-size: 0.7rem;
  font-weight: 600;
  border-radius: 0.8rem;
  padding: 0.25rem 0.6rem;
  display: inline-block;
  margin-bottom: 0.4rem;
}

/* === Grid for Apple Compact Look === */
@media (max-width: 768px) {
  .col-md-4 {
    flex: 0 0 33.33%;
    max-width: 33.33%;
  }
}

@media (max-width: 576px) {
  .col-md-4 {
    flex: 0 0 50%;
    max-width: 50%;
  }

  .card-img-top {
    height: 140px;
  }
}
</style>

<!-- ‚úÖ Sticky Header Search -->
<header class="sticky-top bg-white shadow-sm p-3">
  <div class="container">
    <form method="get" action="">
      <div class="input-group">
        <input 
          type="text" 
          name="q" 
          value="{{ query }}" 
          class="form-control rounded-start-pill" 
          placeholder="Search products..."
        >
        <button class="btn btn-success rounded-end-pill" type="submit">Search</button>
      </div>
    </form>
  </div>
</header>

<!-- ‚úÖ Marketplace Section -->
<div class="container mt-4">
  {% if query %}
    <h4 class="mb-3">Products matching ‚Äú{{ query }}‚Äù</h4>
  {% else %}
    <h4 class="mb-3">WAAPFOLIO MARKETPLACE</h4>
  {% endif %}

  {% if results %}
    <div class="row">
      {% for item in results %}
        <div class="col-md-4 mb-4">
          <div class="card h-100">

            <!-- üåø Mixed Store Badge -->
            {% if item.store.name %}
              <div class="p-2 pt-3 ps-3">
                <span class="store-badge">{{ item.store.name|truncatechars:18 }}</span>
              </div>
            {% endif %}

            <!-- üåø Product Image -->
            {% if item.image %}
              <img src="{{ item.image.url }}" class="card-img-top" alt="{{ item.name }}">
            {% elif item.image_url %}
              <img src="{{ item.image_url }}" class="card-img-top" alt="{{ item.name }}">
            {% else %}
              <img src="{% static 'images/placeholder.png' %}" class="card-img-top" alt="No image available">
            {% endif %}

            <!-- üåø Card Body -->
            <div class="card-body">
              <h5 class="card-title">{{ item.name }}</h5>
              <p class="card-text text-muted">
                {{ item.description|default:"No description"|truncatewords:15 }}
              </p>
              <p class="fw-bold">{{ item.price }} {{ item.currency }}</p>

              <div class="d-flex justify-content-between">
                <a href="{{ item.get_absolute_url }}" class="btn btn-sm btn-success">View</a>
                <a href="{{ item.store.get_absolute_url }}" class="btn btn-sm btn-outline-success">Store</a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>No products found.</p>
  {% endif %}
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const input = document.querySelector('input[name="q"]');
  const resultsContainer = document.querySelector(".row");

  let timeout = null;

  input.addEventListener("keyup", function() {
    clearTimeout(timeout);
    const query = this.value.trim();

    timeout = setTimeout(() => {
      if (query.length < 2) return; // wait till 2+ chars
      fetch(`?q=${encodeURIComponent(query)}`, {
        headers: { "x-requested-with": "XMLHttpRequest" },
      })
      .then(res => res.json())
      .then(data => {
        resultsContainer.innerHTML = "";
        if (data.results.length === 0) {
          resultsContainer.innerHTML = "<p>No products found.</p>";
        } else {
          data.results.forEach(item => {
            const card = `
              <div class="col-md-4 mb-4">
                <div class="card h-100">
                  <div class="p-2 pt-3 ps-3">
                    <span class="store-badge">${item.store_name}</span>
                  </div>
                  <img src="${item.image}" class="card-img-top" alt="${item.name}">
                  <div class="card-body">
                    <h5 class="card-title">${item.name}</h5>
                    <p class="fw-bold">${item.price}</p>
                    <div class="d-flex justify-content-between">
                      <a href="${item.product_url}" class="btn btn-sm btn-success">View</a>
                      <a href="${item.store_url}" class="btn btn-sm btn-outline-success">Store</a>
                    </div>
                  </div>
                </div>
              </div>`;
            resultsContainer.insertAdjacentHTML("beforeend", card);
          });
        }
      });
    }, 400); // ‚è≥ small delay for smooth typing
  });
});
</script>

{% endblock %}
