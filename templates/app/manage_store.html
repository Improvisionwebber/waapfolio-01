{% extends "store_base.html" %}
{% block title %}Manage Store{% endblock %}
{% block body %}
{% load humanize %}

<link href="https://cdn.jsdelivr.net/npm/lightbox2@2/dist/css/lightbox.min.css" rel="stylesheet" />

<!-- Styles retained from your original template -->
<style>
/* ...keep all your existing CSS here... */
</style>

<!-- STORE SWITCH DROPDOWN -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle text-dark" href="#" id="storeDropdown" role="button" 
     data-bs-toggle="dropdown" aria-expanded="false">
      {% if active_store %}{{ active_store.brand_name }}{% else %}Switch Store{% endif %}
  </a>
  <ul class="dropdown-menu" aria-labelledby="storeDropdown">
    {% for store in user_stores %}
    <li class="d-flex align-items-center px-2">
      <a class="dropdown-item flex-grow-1" href="{% url 'switch_store' store.id %}">
          {% if store.id == active_store.id %}âœ” {{ store.brand_name }}{% else %}{{ store.brand_name }}{% endif %}
      </a>
      {% if store.id != active_store.id %}
      <button class="btn btn-sm text-danger border-0"
              data-bs-toggle="modal"
              data-bs-target="#deleteStoreModal"
              data-store-id="{{ store.id }}"
              data-store-name="{{ store.brand_name }}">
          Delete
      </button>
      {% endif %}
    </li>
    {% endfor %}
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item text-success fw-semibold" href="{% url 'create_store' %}">+ Create New Store</a></li>
  </ul>
</li>

<!-- DELETE STORE MODAL -->
<div class="modal fade" id="deleteStoreModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Store</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <b id="storeName"></b>?
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteStoreForm" method="POST">{% csrf_token %}
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- MESSAGES -->
<center>
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
</center>

<!-- VISIT STORE -->
<div class="d-flex justify-content-end mb-4 pd-4 outline-dark">
  {% if store %}
  <a href="{{ store.get_absolute_url }}" class="btn btn-success pt-3 mt-3">
    <i class="bi bi-box-arrow-up-right"></i> Visit Store Page
  </a>
  {% endif %}
</div>

<!-- PRODUCT FORM -->
<div class="container py-4">
  <h2 class="text-center">{{ store.brand_name }} - Manage Your Products</h2>

  {% if edit_mode %}
    <a href="{% url 'manage_store' store.slug %}" class="btn btn-secondary mt-2">Cancel Edit</a>
  {% endif %}

  <form method="POST" 
        action="{% if edit_mode %}{% url 'edit_item' store.slug edit_item.id %}{% else %}{% url 'manage_store' store.slug %}{% endif %}" 
        enctype="multipart/form-data" class="my-4 form no-global-loader">
    {% csrf_token %}
    <h4>{{ edit_mode|yesno:"Edit Product,Add New Product" }}</h4>

    <div class="mb-3">
      {{ form.name.label_tag }}
      {{ form.name }}
    </div>

    <div class="mb-3">
      <label for="price" class="form-label">Price</label>
      <input type="text" id="price" name="price" class="form-control" placeholder="Enter product price (Optional)" value="{{ form.price.value|default:'' }}">
    </div>

    <div class="mb-3">
      <label for="currency" class="form-label">Currency</label>
      <select id="currency" name="currency" class="form-select">
        <option value="NGN" {% if form.currency.value == "NGN" %}selected{% endif %}>ðŸ‡³ðŸ‡¬ NGN (â‚¦)</option>
        <option value="USD" {% if form.currency.value == "USD" %}selected{% endif %}>ðŸ‡ºðŸ‡¸ USD ($)</option>
        <option value="EUR" {% if form.currency.value == "EUR" %}selected{% endif %}>ðŸ‡ªðŸ‡º EUR (â‚¬)</option>
        <option value="GBP" {% if form.currency.value == "GBP" %}selected{% endif %}>ðŸ‡¬ðŸ‡§ GBP (Â£)</option>
        <option value="GHS" {% if form.currency.value == "GHS" %}selected{% endif %}>ðŸ‡¬ðŸ‡­ GHS (â‚µ)</option>
        <option value="MWK" {% if form.currency.value == "MWK" %}selected{% endif %}>ðŸ‡²ðŸ‡¼ MWK (MK)</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="imageInput" class="form-label">Cover Image</label>
      <input type="file" name="image" id="imageInput" class="form-control" accept="image/*">
      <p>Currently:</p>
      <img id="preview" src="{{ edit_item.image_url|default_if_none:edit_item.image.url }}" style="max-width:200px; display:block; margin-top:10px;" />
    </div>

    <div class="mb-3">
      <label for="description" class="form-label">Product Description</label>
      <textarea id="description" name="description" class="form-control" rows="4">{{ form.description.value }}</textarea>
    </div>

    <div class="mb-3">
      <label for="extra_images" class="form-label">Upload Additional Images & Videos</label>
      <input type="file" name="extra_images" id="extra_images" class="form-control" multiple accept="image/*,video/*">
    </div>

    {% if edit_mode and old_images %}
    <hr>
    <h5>Existing Extra Images & Videos</h5>
    <div class="row g-3">
      {% for file in old_images %}
        <div class="col-6 col-md-3 text-center">
          <div class="extra-img-card p-2 shadow-sm rounded bg-white">
            {% if file.file or file.image_url %}
              <img src="{{ file.file.url|default:file.image_url }}" class="img-fluid rounded mb-2" style="height:100px;width:100px;object-fit:cover;" />
              <a href="{% url 'delete_extra_image' store.slug file.id %}" class="btn btn-sm btn-danger w-100 mt-1">ðŸ—‘ Delete</a>
            {% elif file.youtube_url %}
              <iframe width="100%" height="100" src="https://www.youtube.com/embed/{{ file.youtube_id }}" frameborder="0" allowfullscreen></iframe>
              <a href="{% url 'delete_extra_video' store.slug file.id %}" class="btn btn-sm btn-danger w-100 mt-1">ðŸ—‘ Delete</a>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
    <hr>
    {% endif %}

    <button type="submit" class="btn btn-success mt-3">{{ edit_mode|yesno:"Save Changes,FINISH" }}</button>
  </form>

  <!-- PRODUCT LIST -->
  <section class="py-5">
    <hr>
    <center><h1>WAAPS</h1></center>
    <div class="row">
      {% for item in items %}
        <div class="card h-100 shadow-sm border-0 mb-4">
          {% include 'partials/item_card.html' with item=item %}
        </div>
      {% endfor %}
    </div>
  </section>
</div>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay">
  <img src="/static/images/logo-bg.png" alt="Logo" class="loading-logo">
  <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
  <p class="loading-text">Preparing your product detailsâ€¦</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/lightbox2@2/dist/js/lightbox-plus-jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- JS logic retained from your original template -->
<script>
  // ...Keep your JS code as-is, includes delete confirmation, preview images, YouTube upload, loader...
</script>

{% endblock %}
