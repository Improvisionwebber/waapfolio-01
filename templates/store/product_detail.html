{% extends "base.html" %}
{% block title %}{{ product.name }} | {{ product.store.brand_name }}{% endblock %}
{% load static %}
{% load humanize %}

{% block body %}

<div class="container py-5">
  <a href="{% url 'view_store' product.store.slug %}" class="text-decoration-none text-dark mb-3 d-inline-block">
    <i class="bi bi-arrow-left"></i> Back to Store
</a>

    <h3 class="text-center mb-4 fw-bold">{{ product.name }}</h3>

    <div class="row g-4 justify-content-center">
        <div class="col-lg-6">
            <div id="productCarousel" class="carousel slide shadow-lg rounded-4 border border-light border-opacity-25 p-2" 
                 data-bs-ride="carousel" data-bs-interval="5000"
                 style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px);">

                <div class="carousel-inner rounded-4">
                    {% if product.image_url %}
                    <div class="carousel-item active">
                        <img src="{{ product.image_url }}" class="d-block w-100 rounded-4 shadow-lg" 
                             alt="Main Image" style="max-height: 400px; object-fit: contain;">
                    </div>
                    {% endif %}

                    {% for img in images %}
                        {% if img.image_url %}
                        <div class="carousel-item {% if not product.image_url and forloop.first %}active{% endif %}">
                            <img src="{{ img.image_url }}" class="d-block w-100 rounded-4 shadow-lg" 
                                 alt="Extra Image" style="max-height: 400px; object-fit: contain;">
                        </div>
                        {% endif %}
                    {% endfor %}

                    {% for y in youtube_videos %}
                    <div class="carousel-item {% if not product.image_url and not product.image and images|length == 0 and videos|length == 0 and forloop.first %}active{% endif %}">
                        <div class="ratio ratio-16x9">
                        <iframe
                            class="rounded-4 shadow-lg"
                            src="https://www.youtube.com/embed/{{ y.youtube_id }}"
                            title="YouTube video"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                        </iframe>
                        </div>
                    </div>
                    {% endfor %}

                </div>

                <button class="carousel-control-prev bg-white bg-opacity-25 shadow rounded-circle" type="button"
                        data-bs-target="#productCarousel" data-bs-slide="prev" style="width: 50px; height: 50px; top: 45%;">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next bg-white bg-opacity-25 shadow rounded-circle" type="button"
                        data-bs-target="#productCarousel" data-bs-slide="next" style="width: 50px; height: 50px; top: 45%;">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>

      <div class="col-lg-6">
    <div class="p-4 bg-light rounded shadow-sm border product-details-card">
      <h4 class="card-text">
        {% if item.currency == "NGN" %}‚Ç¶{% elif item.currency == "USD" %}${% elif item.currency == "EUR" %}‚Ç¨{% elif item.currency == "GBP" %}¬£{% elif item.currency == "GHS" %}‚Çµ{% endif %}
        {{ item.price|intcomma }}
      </h4>        
        <p class="text-muted">
          Posted on: {{ product.created_at|date:"F j, Y" }} at {{ product.created_at|time:"H:i" }}
        </p>

        <div class="mt-3">
            <h6 class="fw-bold text-secondary">Product Description</h6>
            <p class="text-muted border rounded p-3 bg-white shadow-sm product-description" style="white-space: pre-line; min-height: 150px;">
                {{ product.description|default:"No description available." }}
            </p>
        </div>
        
        <a href="https://wa.me/{{ product.store.whatsapp_number|urlencode }}?text=Hello! I'm interested in your product: {{ product.name }} (‚Ç¶{{ product.price|floatformat:0 }})"
            class="btn btn-success btn-lg w-100 mt-4 shadow-sm">
            <i class="bi bi-whatsapp"></i> Order on WhatsApp
        </a>
<!-- COMMENTS SECTION -->
<div class="mt-5">
  <h5 class="fw-bold mb-3">üí¨ Comments</h5>

  <!-- Comment form -->
  {% if user.is_authenticated %}
    <form method="post" class="mb-4">
      {% csrf_token %}
      {{ form.text }}
      <button type="submit" class="btn btn-success mt-2">Post Comment</button>
    </form>
  {% else %}
    <p><a href="{% url 'login' %}">Log in</a> to leave a comment.</p>
  {% endif %}

  <!-- Display comments -->
  {% if comments %}
    <ul class="list-unstyled">
      {% for c in comments %}
        <li class="mb-3 p-3 border rounded bg-light">
          <strong>{{ c.user.username }}</strong>
          <small class="text-muted">‚Ä¢ {{ c.created_at|timesince }} ago</small>
          <p class="mb-0">{{ c.text|linebreaks }}</p>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-muted">No comments yet. Be the first to comment!</p>
  {% endif %}
</div>


        <div class="mt-4 safety-card p-3 rounded shadow">
            <h5 class="fw-bold text-danger mb-3">Safety Precautions to Avoid Scams</h5>
            <ul class="list-unstyled text-muted mb-0" style="line-height: 1.6;">
                <li>üîí Always verify the seller's identity before making payment.</li>
                <li>üìπ Make sure to request a video call to see the product live.</li>
                <li>üí¨ Use WhatsApp chat to clarify all product details and shipping terms.</li>
                <li>üö´ Never pay upfront without confirming the product's authenticity.</li>
                <li>üìç Prefer cash on delivery (COD) if possible or trusted payment methods.</li>
                <li>‚ö†Ô∏è Be cautious of deals that seem too good to be true.</li>
                <li>üõë Report suspicious sellers or conversations immediately.</li>
            </ul>
        </div>

    </div>
</div>

    </div>
</div>

<style>
#productCarousel .carousel-item img,
#productCarousel .carousel-item video {
    width: 100%;
    height: 400px;
    object-fit: cover;
    border-radius: 0.5rem;
    background-color: #000;
}

.safety-card {
    background: #ffe6e6;
    border: 1px solid #f5c2c2;
    box-shadow: 4px 4px 12px rgba(255, 0, 0, 0.15), -4px -4px 12px rgba(255, 255, 255, 0.8);
    transform-style: preserve-3d;
    transition: transform 0.3s ease;
}
.safety-card:hover {
    transform: translateZ(10px) scale(1.02);
    box-shadow: 8px 8px 20px rgba(255, 0, 0, 0.25), -8px -8px 20px rgba(255, 255, 255, 0.9);
}
.list-unstyled li { margin-bottom: 0.8rem; font-size: 1rem; }

@media (max-width: 768px) {
    #productCarousel .carousel-item img,
    #productCarousel .carousel-item video {
        height: 300px;
    }
}
.extra-img-card img:hover {
    cursor: zoom-in;
    transform: scale(1.05);
    transition: transform 0.3s ease;
}
/* Product details card */
body.dark .product-details-card {
    background-color: #1e1e1e !important;
    border: 1px solid #333 !important;
    color: #eee !important;
}

/* Price */
body.dark .product-details-card .text-success {
    color: #28a745 !important;
}

/* Product description */
body.dark .product-description {
    background-color: #2a2a2a !important;
    color: #eee !important;
    border: 1px solid #444 !important;
}

/* Text headers */
body.dark .product-details-card h6 {
    color: #bbb !important;
}

/* Safety card */
body.dark .safety-card {
    background-color: #2a1a1a !important;
    border: 1px solid #661111 !important;
    color: #eee !important;
}

body.dark .safety-card li {
    color: #ccc !important;
}
body.dark .bg-light {
  background-color: #2a2a2a !important;
  border: 1px solid #444 !important;
  color: #eee !important;
}
body.dark .border {
  border-color: #555 !important;
}


</style>

<!-- Lightbox2 JS -->
<script src="https://cdn.jsdelivr.net/npm/lightbox2@2/dist/js/lightbox-plus-jquery.min.js"></script>
<!-- YouTube Iframe API -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
var ytPlayers = [];
var ytApiReady = false;

function onYouTubeIframeAPIReady() {
  ytApiReady = true;
  initYTPlayers();
}

function initYTPlayers() {
  if (!ytApiReady || !window.YT || !YT.Player) return;

  document.querySelectorAll('#productCarousel iframe').forEach((iframe) => {
    // Ensure enablejsapi + playsinline + origin
    const src = iframe.getAttribute('src') || '';
    if (!src.includes('enablejsapi=1')) {
      try {
        const u = new URL(src);
        u.searchParams.set('enablejsapi','1');
        u.searchParams.set('playsinline','1');
        u.searchParams.set('origin', window.location.origin);
        iframe.src = u.toString();
      } catch(e) {
        iframe.src = src + (src.includes('?') ? '&' : '?') +
                     'enablejsapi=1&playsinline=1&origin=' + encodeURIComponent(window.location.origin);
      }
    }

    if (iframe.dataset.ytBound === '1') return; // prevent double init
    iframe.dataset.ytBound = '1';
    const p = new YT.Player(iframe);
    ytPlayers.push(p);
  });

  // Try to play current active media after players exist
  setTimeout(playActiveMedia, 100);
}

function pauseAllMedia() {
  // Pause HTML5 videos
  document.querySelectorAll('#productCarousel .carousel-item video').forEach(v => {
    try { v.pause(); } catch(e) {}
  });
  // Pause YT players
  ytPlayers.forEach(p => { if (p && p.pauseVideo) p.pauseVideo(); });
}

function playActiveMedia() {
  const carousel = document.getElementById('productCarousel');
  if (!carousel) return;

  // HTML5 video (if present)
  const vid = carousel.querySelector('.carousel-item.active video');
  if (vid) { try { vid.play(); } catch(e) {} }

  // YouTube iframe (mute to satisfy autoplay policies)
  const iframe = carousel.querySelector('.carousel-item.active iframe');
  if (iframe && ytPlayers.length) {
    const player = ytPlayers.find(p => p.getIframe && p.getIframe() === iframe);
    if (player && player.playVideo) {
      if (player.mute) player.mute();
      player.playVideo();
    }
  }
}

document.addEventListener('DOMContentLoaded', function () {
  const carousel = document.getElementById('productCarousel');
  if (!carousel) return;

  // Make sure iframes have enablejsapi even if API loaded early
  document.querySelectorAll('#productCarousel iframe').forEach((iframe) => {
    const src = iframe.getAttribute('src') || '';
    if (!src.includes('enablejsapi=1')) {
      iframe.src = src + (src.includes('?') ? '&' : '?') +
                   'enablejsapi=1&playsinline=1&origin=' + encodeURIComponent(window.location.origin);
    }
  });

  // If API already ready (race), init immediately
  if (window.YT && typeof YT.Player === 'function') {
    ytApiReady = true;
    initYTPlayers();
  }

  // Pause current on slide start, play new one after slide ends
  carousel.addEventListener('slide.bs.carousel', pauseAllMedia);
  carousel.addEventListener('slid.bs.carousel', playActiveMedia);

  // Initial attempt to play the first active item (if video/YouTube)
  setTimeout(playActiveMedia, 300);
});
</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
