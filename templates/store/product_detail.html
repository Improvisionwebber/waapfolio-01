{% extends "store_base.html" %}
{% block title %}{{ product.name }} | {{ product.store.brand_name }}{% endblock %}
{% load static %}
{% load humanize %}
{% block body %}

<div class="container py-5">

  <a href="{% url 'view_store' product.store.slug %}" class="text-decoration-none text-dark mb-3 d-inline-block">
    <i class="bi bi-arrow-left"></i> Back to Store
  </a>

  <h3 class="text-center mb-4 fw-bold">{{ product.name }}</h3>

  <div class="row g-4 justify-content-center">

    <!-- LEFT SIDE -->
    <div class="col-lg-6">

<!-- MAIN DISPLAY -->
<div class="main-image-wrapper shadow-lg rounded-4 mb-3" id="mainDisplayWrapper">
  <img id="mainDisplayImage"
       src="{{ product.image_url }}"
       class="main-display-img img-fluid rounded-4"
       alt="{{ product.name }}">
</div>

<!-- THUMBNAILS -->
<div class="d-flex flex-wrap gap-2 thumbnail-row">
  {% if product.image_url %}
      <img src="{{ product.image_url }}" class="thumb-img" onclick="showMainImage(this.src)">
  {% endif %}

  {% for img in product.extra_files.all %}
      {% if img.image %}
          <img src="{{ img.image.url }}" class="thumb-img" onclick="showMainImage(this.src)">
      {% elif img.image_url %}
          <img src="{{ img.image_url }}" class="thumb-img" onclick="showMainImage(this.src)">
      {% endif %}
  {% endfor %}


    {% for y in product.media.all %}
        {% if y.youtube_id %}
        <div class="thumb-video" onclick="showMainVideo('{{ y.youtube_id }}')">
            <i class="bi bi-play-circle video-icon"></i>
        </div>
        {% endif %}
    {% endfor %}





</div>


    </div>

    <!-- RIGHT SIDE -->
    <div class="col-lg-6">
      <div class="p-4 bg-light rounded shadow-sm border product-details-card">

        <h4 class="text-success fw-bold">
          {% if product.currency == "NGN" %}‚Ç¶{% elif product.currency == "USD" %}${% elif product.currency == "EUR" %}‚Ç¨{% elif product.currency == "GBP" %}¬£{% elif product.currency == "GHS" %}‚Çµ{% endif %}
          {{ product.price|intcomma }}
        </h4>

        <p class="text-muted">
          Posted on: {{ product.created_at|date:"F j, Y" }} at {{ product.created_at|time:"H:i" }}
        </p>

        <div class="mt-3">
          <h6 class="fw-bold text-secondary">Product Description</h6>
          <p class="text-muted border rounded p-3 bg-white shadow-sm product-description" style="white-space: pre-line; min-height: 150px;">
            {{ product.description|default:"No description available." }}
          </p>
        </div>

        <a href="https://wa.me/{{ product.store.whatsapp_number|urlencode }}?text=Hello!, I found you on Waap Folio and I'm interested in your product: {{ product.name }} (‚Ç¶{{ product.price|floatformat:0 }})"
           class="btn btn-success btn-lg w-100 mt-4 shadow-sm"
           onclick="recordOrder('{{ product.store.id }}')">
          <i class="bi bi-whatsapp"></i> Order on WhatsApp
        </a>



        <!-- COMMENTS -->
        <div class="mt-5">
          <h5 class="fw-bold mb-3">üí¨ Comments</h5>

          {% if user.is_authenticated %}
          <form method="post" class="mb-4">
            {% csrf_token %}
            {{ form.text }}
            <button type="submit" class="btn btn-success mt-2">Post Comment</button>
          </form>
          {% else %}
          <p><a href="{% url 'login' %}">Log in</a> to leave a comment.</p>
          {% endif %}

          {% if comments %}
          <ul class="list-unstyled">
            {% for c in comments %}
            <li class="mb-3 p-3 border rounded bg-light">
              <strong>{{ c.user.username }}</strong>
              <small class="text-muted">‚Ä¢ {{ c.created_at|timesince }} ago</small>
              <p class="mb-0">{{ c.text|linebreaks }}</p>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted">No comments yet. Be the first to comment!</p>
          {% endif %}
        </div>
<hr class="my-5">

<!-- YOU MAY ALSO LIKE -->
<div class="mt-3">
  <h5 class="fw-bold text-success mb-3">You may also like</h5>

  {% if items_meta %}
    <div class="row g-2">
      {% for meta in items_meta %}
        <div class="col-6 col-md-3">
          <a href="{{ meta.product_url }}" class="d-block">
            <img 
              src="{{ meta.cover_url }}" 
              alt="{{ meta.item.name }}" 
              class="img-fluid rounded shadow-sm"
              style="width: 100%; height: 150px; object-fit: cover;"
            >
          </a>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">No products to show yet.</p>
  {% endif %}

</div>
        <div class="mt-4 safety-card p-3 rounded shadow">
          <h5 class="fw-bold text-danger mb-3">Safety Precautions to Avoid Scams</h5>
          <ul class="list-unstyled text-muted mb-0" style="line-height: 1.6;">
            <li>üîí Always verify the seller's identity before making payment.</li>
            <li>üìπ Request a video call to see the product live.</li>
            <li>üí¨ Confirm shipping terms before paying.</li>
            <li>üö´ Avoid upfront payment without verification.</li>
            <li>üìç Prefer cash on delivery (COD) if possible.</li>
            <li>‚ö†Ô∏è Be cautious of deals that look too good to be true.</li>
            <li>üõë Report suspicious sellers immediately.</li>
          </ul>
        </div>

      </div>
    </div>

  </div>
</div>


<style>
#productCarousel .carousel-item img,
#productCarousel .carousel-item video {
  width: 100%;
  height: 400px;
  object-fit: cover;
  border-radius: 0.5rem;
  background-color: #000;
}

@media (max-width: 768px) {
  #productCarousel .carousel-item img,
  #productCarousel .carousel-item video {
    height: 300px;
  }
}

/* MAIN IMAGE */
.main-image-wrapper {
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(20px);
  max-height: 450px;
  overflow: hidden;
}
.main-display-img {
  object-fit: contain;
  max-height: 270px;
  transition: 0.35s ease;
  width: 100px;

}

/* THUMBNAILS */
.thumb-img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 10px;
  border: 2px solid transparent;
  cursor: pointer;
  transition: 0.3s ease;
}
.thumb-img:hover {
  transform: scale(1.08);
  border-color: #28a745;
}

.thumb-video {
  width: 70px;
  height: 70px;
  border-radius: 10px;
  background: #000;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  transition: 0.3s ease;
}
.thumb-video:hover {
  transform: scale(1.08);
}
.video-icon {
  font-size: 30px;
  color: #fff;
  opacity: 0.8;
}

/* SAFETY CARD */
.safety-card {
  background: #ffe6e6;
  border: 1px solid #f5c2c2;
  box-shadow: 4px 4px 12px rgba(255, 0, 0, 0.15);
  transition: 0.3s ease;
}
.safety-card:hover {
  transform: scale(1.02);
  box-shadow: 8px 8px 20px rgba(255, 0, 0, 0.25);
}

/* RELATED PRODUCTS */
.hover-up {
  transition: 0.25s ease;
}
.hover-up:hover {
  transform: translateY(-5px);
}

/* DARK MODE FIXES */
body.dark .product-details-card {
  background: #1e1e1e !important;
  border: 1px solid #333 !important;
}
body.dark .product-description {
  background: #2a2a2a !important;
  border: 1px solid #444 !important;
}
body.dark .safety-card {
  background: #2a1a1a !important;
  border: 1px solid #661111 !important;
}
/* Make the wrapper full width */
.main-image-wrapper {
    width: 100%;
}

/* Make the image fill the wrapper fully */
.main-display-img {
    width: 100%;       /* Full width */
    height: auto;      /* Keep aspect ratio */
    display: block;    /* Remove any spacing below the image */
    object-fit: cover; /* Optional: ensures image covers container nicely */
}

</style>

<!-- Lightbox2 JS -->
<script src="https://cdn.jsdelivr.net/npm/lightbox2@2/dist/js/lightbox-plus-jquery.min.js"></script>
<!-- YouTube Iframe API -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
var ytPlayers = [];
var ytApiReady = false;

function onYouTubeIframeAPIReady() {
  ytApiReady = true;
  initYTPlayers();
}

function initYTPlayers() {
  if (!ytApiReady || !window.YT || !YT.Player) return;

  document.querySelectorAll('#productCarousel iframe').forEach((iframe) => {
    // Ensure enablejsapi + playsinline + origin
    const src = iframe.getAttribute('src') || '';
    if (!src.includes('enablejsapi=1')) {
      try {
        const u = new URL(src);
        u.searchParams.set('enablejsapi','1');
        u.searchParams.set('playsinline','1');
        u.searchParams.set('origin', window.location.origin);
        iframe.src = u.toString();
      } catch(e) {
        iframe.src = src + (src.includes('?') ? '&' : '?') +
                     'enablejsapi=1&playsinline=1&origin=' + encodeURIComponent(window.location.origin);
      }
    }

    if (iframe.dataset.ytBound === '1') return; // prevent double init
    iframe.dataset.ytBound = '1';
    const p = new YT.Player(iframe);
    ytPlayers.push(p);
  });

  // Try to play current active media after players exist
  setTimeout(playActiveMedia, 100);
}

function pauseAllMedia() {
  // Pause HTML5 videos
  document.querySelectorAll('#productCarousel .carousel-item video').forEach(v => {
    try { v.pause(); } catch(e) {}
  });
  // Pause YT players
  ytPlayers.forEach(p => { if (p && p.pauseVideo) p.pauseVideo(); });
}

function playActiveMedia() {
  const carousel = document.getElementById('productCarousel');
  if (!carousel) return;

  // HTML5 video (if present)
  const vid = carousel.querySelector('.carousel-item.active video');
  if (vid) { try { vid.play(); } catch(e) {} }

  // YouTube iframe (mute to satisfy autoplay policies)
  const iframe = carousel.querySelector('.carousel-item.active iframe');
  if (iframe && ytPlayers.length) {
    const player = ytPlayers.find(p => p.getIframe && p.getIframe() === iframe);
    if (player && player.playVideo) {
      if (player.mute) player.mute();
      player.playVideo();
    }
  }
}

document.addEventListener('DOMContentLoaded', function () {
  const carousel = document.getElementById('productCarousel');
  if (!carousel) return;

  // Make sure iframes have enablejsapi even if API loaded early
  document.querySelectorAll('#productCarousel iframe').forEach((iframe) => {
    const src = iframe.getAttribute('src') || '';
    if (!src.includes('enablejsapi=1')) {
      iframe.src = src + (src.includes('?') ? '&' : '?') +
                   'enablejsapi=1&playsinline=1&origin=' + encodeURIComponent(window.location.origin);
    }
  });

  // If API already ready (race), init immediately
  if (window.YT && typeof YT.Player === 'function') {
    ytApiReady = true;
    initYTPlayers();
  }

  // Pause current on slide start, play new one after slide ends
  carousel.addEventListener('slide.bs.carousel', pauseAllMedia);
  carousel.addEventListener('slid.bs.carousel', playActiveMedia);

  // Initial attempt to play the first active item (if video/YouTube)
  setTimeout(playActiveMedia, 300);
});
function recordOrder(storeId) {
  fetch(`/record-order/${storeId}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": getCookie("csrftoken"),
      "Content-Type": "application/json"
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      console.log("Order recorded:", data.total_orders);
    }
  })
  .catch(err => console.error("Error recording order:", err));
  
  // let WhatsApp link continue
  return true;
}

// Helper: get CSRF token from cookie
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
function changeMainImage(src) {
    const main = document.getElementById("mainDisplayImage");
    if (!main) return;

    main.style.opacity = "0";
    setTimeout(() => {
        main.src = src;
        main.style.opacity = "1";
    }, 200);
}

function changeMainVideo(youtubeId) {
    const main = document.getElementById("mainDisplayImage");
    if (!main) return;

    main.style.opacity = "0";
    setTimeout(() => {
        main.src = `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg`;
        main.style.opacity = "1";
    }, 200);
}
function showMainImage(src) {
    const wrapper = document.getElementById('mainDisplayWrapper');
    wrapper.innerHTML = `<img id="mainDisplayImage" src="${src}" class="w-100 rounded-4 main-display-img img-fluid">`;
}

function showMainVideo(youtubeId) {
    const wrapper = document.getElementById('mainDisplayWrapper');
    wrapper.innerHTML = `
        <div class="ratio ratio-16x9">
          <iframe
            src="https://www.youtube.com/embed/${youtubeId}?autoplay=1&mute=1"
            title="YouTube video"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            class="rounded-4 shadow-lg w-100 h-100">
          </iframe>
        </div>`;
}
</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
