{% extends "base.html" %}

{% block title %}CREATE YOUR WAAP FOLIO STORE{% endblock %}

{% load static %}
{% load widget_tweaks %}

{% block body %}

<!-- CSS for intl-tel-input -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />

<form method="POST" enctype="multipart/form-data" class="form" style="padding-bottom: 80px;">
    {% csrf_token %}

    <!-- A. STORE IDENTITY -->
    <h4>Store Identity</h4>
    <p>
        {{ form.brand_name.label_tag }}
        {{ form.brand_name }}
        {{ form.brand_name.errors }}
    </p>

    <p>
        <label>Brand Logo Preview:</label><br>
        <img id="logo-preview"
             src="{{ form.instance.brand_logo|default:'' }}"
             alt="Logo Preview"
             style="max-width:200px; border-radius:8px; margin-bottom:10px;"
             {% if not form.instance.brand_logo %}hidden{% endif %}>
        <br>
        {{ form.brand_logo.label_tag }}
        {{ form.brand_logo }}
        {{ form.brand_logo.errors }}
    </p>

    <p>
        {{ form.favicon.label_tag }} <small>(optional, premium)</small>
        {{ form.favicon }}
        {{ form.favicon.errors }}
    </p>

    <!-- B. ORDER CHANNEL -->
    <h4>Order Channel</h4>
    <p>
        <label for="id_order_system">Choose Order System:</label>
        <select id="id_order_system" name="order_system" class="form-control">
            <option value="whatsapp" {% if form.instance.order_system == 'whatsapp' %}selected{% endif %}>WhatsApp</option>
            <option value="telegram" {% if form.instance.order_system == 'telegram' %}selected{% endif %}>Telegram</option>
            <option value="facebook" {% if form.instance.order_system == 'facebook' %}selected{% endif %}>Facebook Messenger</option>
            <option value="instagram" {% if form.instance.order_system == 'instagram' %}selected{% endif %}>Instagram DM</option>
        </select>
    </p>

    <!-- Order system dependent fields -->
    <p id="whatsapp-field" style="display:none;">
        {{ form.whatsapp_number.label_tag }}
        {{ form.whatsapp_number }}
        {{ form.whatsapp_number.errors }}
    </p>

    <p id="telegram-field" style="display:none;">
        {{ form.telegram_username.label_tag }}
        {{ form.telegram_username }}
        {{ form.telegram_username.errors }}
    </p>

    <p id="facebook-field" style="display:none;">
        {{ form.facebook_link.label_tag }}
        {{ form.facebook_link }}
        {{ form.facebook_link.errors }}
    </p>

    <p id="instagram-field" style="display:none;">
        {{ form.instagram_link.label_tag }}
        {{ form.instagram_link }}
        {{ form.instagram_link.errors }}
    </p>

    <!-- C. BRAND INFORMATION -->
    <h4>Brand Information</h4>
    <p>
        {{ form.bio.label_tag }}
        {{ form.bio }}
        {{ form.bio.errors }}
    </p>
    <p>
        {{ form.about.label_tag }}
        {{ form.about }}
        {{ form.about.errors }}
    </p>
    <p>
        {{ form.mission.label_tag }}
        {{ form.mission }}
        {{ form.mission.errors }}
    </p>
    <p>
        {{ form.founder_name.label_tag }} <small>(optional)</small>
        {{ form.founder_name }}
        {{ form.founder_name.errors }}
    </p>
    <p>
        {{ form.brand_story.label_tag }} <small>(optional)</small>
        {{ form.brand_story }}
        {{ form.brand_story.errors }}
    </p>

    <!-- D. CONTACT & SOCIALS -->
    <h4>Contact & Socials</h4>
    <p>
        {{ form.address.label_tag }} <small>(optional)</small>
        {{ form.address }}
        {{ form.address.errors }}
    </p>

    <p>
        {{ form.background_color.label_tag }}
        {{ form.background_color }}
        {{ form.background_color.errors }}
    </p>

    <p>
        {{ form.email.label_tag }} <small>(optional)</small>
        {{ form.email }}
        {{ form.email.errors }}
    </p>

    <button type="submit" class="btn btn-primary">
        {% if form.instance.pk %}Save Changes{% else %}Create Store{% endif %}
    </button>
</form>

<!-- JS for intl-tel-input -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
<script>
    const phoneInput = document.querySelector("#id_whatsapp_number");
    if(phoneInput){
        const iti = window.intlTelInput(phoneInput, {
            initialCountry: "ng",
            preferredCountries: ["ng", "us", "gb"],
            separateDialCode: false,
            nationalMode: false,
            formatOnDisplay: false,
            autoHideDialCode: false,
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
        });

        function keepFullNumber() {
            const fullNumber = iti.getNumber();
            if (fullNumber) phoneInput.value = fullNumber;
        }

        phoneInput.addEventListener("blur", keepFullNumber);
        document.addEventListener("DOMContentLoaded", keepFullNumber);
        document.querySelector("form").addEventListener("submit", keepFullNumber);
    }

    // Logo preview
    const logoInput = document.querySelector('#id_brand_logo');
    const logoPreview = document.querySelector('#logo-preview');
    if(logoInput){
        logoInput.addEventListener('change', function(event){
            const file = event.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = function(e){
                    logoPreview.src = e.target.result;
                    logoPreview.hidden = false;
                }
                reader.readAsDataURL(file);
            }
        });
    }

    // Show/hide order fields based on selection
    const orderSelect = document.getElementById('id_order_system');
    const whatsappField = document.getElementById('whatsapp-field');
    const telegramField = document.getElementById('telegram-field');
    const facebookField = document.getElementById('facebook-field');
    const instagramField = document.getElementById('instagram-field');

    function toggleOrderFields() {
        const val = orderSelect.value;
        whatsappField.style.display = (val === 'whatsapp') ? 'block' : 'none';
        telegramField.style.display = (val === 'telegram') ? 'block' : 'none';
        facebookField.style.display = (val === 'facebook') ? 'block' : 'none';
        instagramField.style.display = (val === 'instagram') ? 'block' : 'none';
    }

    orderSelect.addEventListener('change', toggleOrderFields);
    document.addEventListener('DOMContentLoaded', toggleOrderFields);
</script>

<style>
    form p {
        margin-bottom: 20px;
    }
    form p label {
        display: block;
        font-weight: bold;
        margin-bottom: 6px;
        font-size: 14px;
        color: #333;
    }
    form p input,
    form p select,
    form p textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
    }
</style>

{% endblock %}
