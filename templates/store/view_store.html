{% extends "base.html" %}
{% block title %}{{ store.brand_name }} | Powered by Vend{% endblock title %}
{% block body %}
{% load static %}

<!-- STORE HEADER SECTION -->
{% if request.user.is_authenticated and request.user == store.owner %}
 <div class="d-flex justify-content-end mb-4 pd-4 outline-dark">
  <a href="{% url 'manage_store' store.slug %}" class="btn btn-success pt-3 mt-3">
    <i class="bi bi-box-arrow-up-right"></i> Manage Store
  </a>
</div>
{% endif %}

<section class="py-5 bg-light">
  <div class="container text-center">

    {% if store.brand_logo %}
      <img src="{{ store.brand_logo }}" alt="{{ store.brand_name }} Logo" class="rounded-circle" width="120" height="120">
    {% elif store.brand_logo_url %}
      <img src="{{ store.brand_logo_url }}" alt="{{ store.brand_name }} Logo" class="rounded-circle" width="120" height="120">
    {% else %}
      <img src="{% static 'images/logo.png' %}" alt="{{ store.brand_name }} Logo" class="rounded-circle" width="120" height="120">
    {% endif %}

    <h1 class="fw-bold mt-3">{{ store.brand_name }}</h1>
    <p class="lead text-muted mb-4">{{ store.custom_message }}</p>

    <!-- STORE LINK SECTION -->
    <div class="input-group mx-auto mb-3" style="max-width: 500px;">
      <input type="text" id="storeLink" class="form-control form-control-lg" value="{{ full_url }}" readonly>
      <button class="btn btn-outline-primary" onclick="copyStoreLink()">Copy</button>
    </div>

    <!-- SHARE / CONTACT BUTTONS -->
    <div class="d-flex flex-column flex-sm-row justify-content-center gap-2">
      <a href="https://wa.me/?text=Check%20out%20my%20store%20on%20Vend:%20{{ full_url }}" target="_blank" class="btn btn-success btn-lg">
        ðŸ“¤ Share on WhatsApp
      </a>
      <a href="{{ whatsapp_link }}" class="btn btn-outline-success btn-lg">
        ðŸ’¬ Contact Seller
      </a>
    </div>
  </div>
</section>

<!-- PRODUCTS GRID -->
<section class="py-5">
  <div class="container">
    <h3 class="text-center mb-4 fw-semibold">Products</h3>
    <div class="row g-4 justify-content-center">
      {% for meta in items_meta %}
        {% with item=meta.item %}
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card h-100 shadow-sm border-0 rounded-4 overflow-hidden">

              <!-- Product Image -->
              <a href="{{ meta.product_url }}">
                <img src="{{ meta.cover_url }}" class="card-img-top img-fluid object-fit-cover"
                     style="height:220px;" alt="{{ item.name }}">
              </a>

              <!-- Card Body -->
              <div class="card-body text-center p-3">
                <h6 class="text-uppercase fw-bold mb-1">{{ item.name }}</h6>
                <p class="text-success fs-5 fw-semibold">â‚¦{{ item.price }}</p>
              <!-- Actions -->
              <div class="d-flex justify-content-center align-items-center gap-3 my-2 bg-light p-2 rounded">

                <!-- Like -->
                <button class="btn-like btn btn-outline-danger btn-sm rounded-circle d-flex align-items-center justify-content-center"
                        data-item-id="{{ item.id }}" 
                        style="width:40px; height:40px; background-color: #fff; border-width:2px;">
                  <i class="bi bi-heart-fill text-danger"></i>
                </button>
                <span id="likes-count-{{ item.id }}" class="small fw-bold text-dark ms-1">{{ meta.likes_count }}</span>

                <!-- Views -->
                <div class="text-dark small d-flex align-items-center ms-3">
                  <i class="bi bi-eye me-1 text-primary"></i>
                  <span class="fw-bold">{{ item.views }}</span>
                </div>

                <!-- Share -->
                <button type="button" class="btn btn-outline-success btn-sm rounded-circle d-flex align-items-center justify-content-center ms-3"
                        style="width:40px; height:40px; background-color:#fff; border-width:2px;"
                        onclick="shareProduct('{{ meta.product_url }}', '{{ item.name|escapejs }}')">
                  <i class="bi bi-share-fill text-success"></i>
                </button>

              </div>

              <style>
                /* Hover effects */
                .btn-like:hover {
                  background-color: #ffe6e6;
                }
                .btn-outline-success:hover {
                  background-color: #e6ffe6;
                }
              </style>


                <!-- View Details Button -->
                <a href="{{ meta.product_url }}" class="btn btn-outline-success w-100 rounded-pill mt-2">
                  View Details
                </a>
              </div>
            </div>
          </div>
        {% endwith %}
      {% endfor %}
    </div>
  </div>
</section>

<!-- Share Script -->
<script>
  function shareProduct(url, name){
    const text = encodeURIComponent(`Check out ${name}: ${url}`);
    const whatsapp = `https://wa.me/?text=${text}`;
    window.open(whatsapp, '_blank');
  }
</script>

<!-- Custom Styles -->
<style>
  .object-fit-cover {
    object-fit: cover;
  }
  @media (max-width: 576px) {
    .card-body p {
      font-size: 0.9rem;
    }
  }
</style>

<!-- Copy Store Link -->
<script>
  function copyStoreLink() {
    const input = document.getElementById("storeLink");
    input.select();
    input.setSelectionRange(0, 99999); // For mobile
    navigator.clipboard.writeText(input.value).then(() => {
      alert("Store link copied!");
    });
  }
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // LIKE TOGGLE
  document.querySelectorAll(".btn-like").forEach(button => {
    button.addEventListener("click", function () {
      const itemId = this.getAttribute("data-item-id");
      fetch(`/like-item/${itemId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
      })
      .then(res => res.json())
      .then(data => {
        if (data.redirect) {
          window.location.href = data.redirect;
        } else {
          document.querySelector(`#likes-count-${itemId}`).textContent = data.likes;
        }
      });
    });
  });
});

// SHARE FUNCTION
function shareProduct(url, name) {
  if (navigator.share) {
    navigator.share({
      title: name,
      text: `Check out ${name}`,
      url: url
    });
  } else {
    const text = encodeURIComponent(`Check out ${name}: ${url}`);
    window.open(`https://wa.me/?text=${text}`, "_blank");
  }
}
</script>


{% endblock %}
